<!-- Header -->
<header class="bg-gray-800 shadow-lg border-b border-gray-700">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Button Game Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'purple-rank': '#6A4C93',
                        'blue-rank': '#4069C0',
                        'green-rank': '#509B69',
                        'yellow-rank': '#CBA635',
                        'orange-rank': '#DB7C30',
                        'red-rank': '#C24141',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        .color-purple { background-color: rgb(106, 76, 147, 0.9); }
        .color-blue { background-color: rgb(64, 105, 192, 0.9); }
        .color-green { background-color: rgb(80, 155, 105, 0.9); }
        .color-yellow { background-color: rgb(203, 166, 53, 0.9); }
        .color-orange { background-color: rgb(219, 124, 48, 0.9); }
        .color-red { background-color: rgb(194, 65, 65, 0.9); }
        
        .border-color-purple { border-color: #6A4C93; }
        .border-color-blue { border-color: #4069C0; }
        .border-color-green { border-color: #509B69; }
        .border-color-yellow { border-color: #CBA635; }
        .border-color-orange { border-color: #DB7C30; }
        .border-color-red { border-color: #C24141; }

        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #60A5FA;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #activityTooltip {
            z-index: 1000;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
        }

        .group:hover #activityTooltip {
            opacity: 1;
        }

        /* Side Panel Animation */
        .side-panel {
            transition: transform 0.5s ease-in-out;
            transform: translateX(100%);
        }

        .side-panel.active {
            transform: translateX(0);
        }

        .main-content {
            transition: transform 0.5s ease-in-out;
        }

        .main-content.shifted {
            transform: translateX(-20%);
        }

        /* Image grid hover effect */
        .game-screenshot {
            transition: transform 0.3s ease;
        }
        
        .game-screenshot:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen relative">
    <!-- Side Panel -->
    <div id="sidePanel" class="side-panel fixed top-0 right-0 w-4/5 h-full bg-gray-900 shadow-2xl overflow-y-auto z-50 border-l border-gray-700">
        <button onclick="closeSidePanel()" class="absolute top-6 right-6 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="p-8">
            <h2 class="text-3xl font-bold mb-4">The Button Game</h2>
         
            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <div class="md:w-1/2">
                    <p class="text-gray-300 text-lg mb-6">Hello! My name is K3N, and I would like to tell you about a community game bot called "The Button" that I created.</p>
                    
                    <p class="text-gray-300 text-lg mb-6">It's basically like playing "keep the balloon up"/"hot potato"/"don't let the bomb explode" but in Discord.</p>
                    
                    <p class="text-gray-300 text-lg mb-6">Everyone works together to keep a timer from hitting zero by clicking, so when someone clicks, it resets for everyone. The closer to zero the button gets, the rarer the color it changes to. So a user might be waiting to grab a specific color, and someone swoops in and "steals" it from them. I've seen some cool user interaction with this!</p>
         
                    <div class="bg-gray-700 rounded-lg p-4 mt-4">
                        <div class="h-40">
                            <img src="image2.png" alt="A user obtaining a red button click" class="w-full h-full object-contain rounded-lg">
                        </div>
                        <p class="text-sm text-gray-300 mt-2 text-center">A user obtaining the rarest color! People were very excited.</p>
                    </div>
                </div>
         
                <div class="md:w-1/2 bg-gray-700 rounded-lg p-4">
                    <div class="h-[600px]">
                        <img src="image1.png" alt="The Button Game Screenshot on Discord" class="w-full h-full object-contain rounded-lg">
                    </div>
                    <p class="text-sm text-gray-300 mt-2 text-center">The button game shown on Discord's mobile app.</p>
                </div>
            </div>
         
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-2xl font-bold mb-4">Global Statistics</h3>
                <div id="globalStats" class="grid grid-cols-2 gap-4">
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-2xl font-bold mb-4">Technical Overview</h3>
                
                <!-- TLDR Section -->
                <div class="bg-gray-700 rounded-lg p-4 mb-6">
                    <h4 class="text-xl font-bold mb-2">TL;DR</h4>
                    <p class="text-gray-300">
                        The Button is a Discord bot implementing a continuous community game where users collectively prevent a timer from reaching zero. It uses a MySQL database for persistence, handles concurrent interactions through connection pooling, and implements a sophisticated color-based ranking system that rewards risky timing-based gameplay.
                    </p>
                </div>
            
                <!-- Technical Deep Dive -->
                <div class="text-gray-300 space-y-4">
                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-2">Architecture Overview</h4>
                        <p class="mb-2">The system implements a distributed real-time interactive game environment utilizing:</p>
                        <ul class="list-disc list-inside pl-4 space-y-2">
                            <li>Asynchronous event handling through Discord.py's event loop</li>
                            <li>Connection pooling for database concurrency management</li>
                            <li>Sophisticated state management with atomic operations</li>
                            <li>Multi-layered caching system for performance optimization</li>
                        </ul>
                    </div>
            
                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-2">Core Mechanics</h4>
                        <p class="mb-2">The fundamental game loop operates on several key principles:</p>
                        <ul class="list-disc list-inside pl-4 space-y-2">
                            <li>Timer Mechanics: Implements a continuous countdown system with configurable duration (default: 43200 seconds)</li>
                            <li>Color States: Utilizes six distinct states based on remaining time percentage:
                                <ul class="list-disc list-inside pl-8 text-sm">
                                    <li>Purple (83.33-100%): Lowest risk, lowest reward</li>
                                    <li>Blue (66.67-83.32%): Low risk</li>
                                    <li>Green (50.00-66.66%): Moderate risk</li>
                                    <li>Yellow (33.33-49.99%): High risk</li>
                                    <li>Orange (16.67-33.32%): Very high risk</li>
                                    <li>Red (0-16.66%): Maximum risk, maximum reward</li>
                                </ul>
                            </li>
                            <li>Concurrency Control: Implements mutex locking for critical sections and connection pooling for database operations</li>
                        </ul>
                    </div>
            
                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-2">Technical Implementation Notes</h4>
                        <p class="mb-2">Key technical considerations include:</p>
                        <ul class="list-disc list-inside pl-4 space-y-2">
                            <li>Race Condition Handling: Utilizes database transactions and row-level locking</li>
                            <li>Cache Management: Implements multi-layer caching with TTL for game state and user data</li>
                            <li>Error Recovery: Automatic reconnection and state recovery mechanisms</li>
                            <li>Performance Optimization: Batch operations and connection pooling</li>
                        </ul>
                    </div>
            
                    <div class="bg-gray-700 rounded-lg p-4 mt-6">
                        <h4 class="text-lg font-bold mb-2">Security & Privacy Notice</h4>
                        <p>The bot requires minimal permissions: managing color roles and message management in designated channels. All role management is confined to game-specific roles at the bottom of the server hierarchy.</p>
                        <p class="mt-2">Required channels:</p>
                        <ul class="list-disc list-inside pl-4">
                            <li>Button channel: Displays game state and controls</li>
                            <li>Chat channel: Activity notifications and community interaction</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="setupPanel" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden border border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-100">Setup Your Own Button Game</h3>
                        <button onclick="closeSetupPanel()" class="text-gray-400 hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 150px);">
                    <div class="space-y-6">
                        <!-- Contact Info -->
                        <div class="bg-blue-600/20 border border-blue-500 rounded-lg p-4 mb-6">
                            <h4 class="text-xl font-bold mb-2">📬 First Step: Contact</h4>
                            <p class="text-gray-300">
                                Reach out to <span class="font-bold text-blue-400">Regen2Moon</span> on Discord to start the process.
                            </p>
                        </div>

                        <!-- Setup Steps -->
                        <div class="bg-gray-700 rounded-lg p-6">
                            <h4 class="text-xl font-bold mb-4">🔧 Server Setup Steps</h4>
                            
                            <div class="space-y-4">
                                <!-- Step 1: Bot Role -->
                                <div class="bg-gray-800 rounded p-4">
                                    <h5 class="font-bold text-blue-400 mb-2">Step 1: Create Bot Role</h5>
                                    <p class="text-gray-300">Create a role called "The Button Bot" with no initial permissions</p>
                                </div>

                                <!-- Step 2: Channels -->
                                <div class="bg-gray-800 rounded p-4">
                                    <h5 class="font-bold text-blue-400 mb-2">Step 2: Create Required Channels</h5>
                                    <div class="space-y-2">
                                        <div class="bg-gray-700 p-3 rounded">
                                            <code class="text-gray-300">#the-button-game</code>
                                            <p class="text-sm text-gray-400 mt-1">Main channel for the button interface</p>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded">
                                            <code class="text-gray-300">#the-button-chat</code>
                                            <p class="text-sm text-gray-400 mt-1">Channel for game notifications and community interaction</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Permissions -->
                                <div class="bg-gray-800 rounded p-4">
                                    <h5 class="font-bold text-blue-400 mb-2">Step 3: Channel Permissions</h5>
                                    <p class="text-gray-300 mb-3">Give "The Button Bot" role these permissions in both channels:</p>
                                    <ul class="list-disc list-inside space-y-1 text-gray-300 pl-4">
                                        <li>Manage Messages</li>
                                        <li>Add Images</li>
                                        <li>Embed Links</li>
                                        <li>Add Reactions</li>
                                        <li>Manage Reactions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="bg-green-600/20 border border-green-500 rounded-lg p-4">
                            <h4 class="text-lg font-bold mb-2">✨ Ready to Go!</h4>
                            <p class="text-gray-300">
                                Once these steps are completed, contact Regen2Moon again and they'll help you get the bot set up and running in your server!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg border-b border-gray-700">
            <div class="container mx-auto px-4 py-6 relative">
            <div class="absolute right-4 top-1/2 -translate-y-1/2 flex gap-4">
                <button onclick="openSetupPanel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                Want your own button?
                </button>
                <button onclick="openSidePanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                About The Game
                </button>
            </div>
            <h1 class="text-4xl font-bold text-center text-gray-100">The Button Game Stats</h1>
            <br>
            <h2 class="text-lg font-bold text-center text-gray-400">By Regen2Moon (K3N), Inspired by Josh Wardle.</h2>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Loading State -->
            <div id="loadingState" class="flex items-center justify-center py-12">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-300">Loading game data...</span>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-red-900 border-l-4 border-red-500 text-red-100 p-4 mb-8" role="alert">
                <p class="font-bold">Error</p>
                <p>Failed to load game data. Please try again later.</p>
            </div>
            
            <div class="text-2xl font-bold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Game List</div>

            <!-- Active Games Grid -->
            <div id="activeGames" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                <!-- Games will be inserted here by JavaScript -->
            </div>

            <!-- Recent Clicks Section -->
            <section class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-6 mb-8 border border-gray-700">
                <h2 class="text-3xl font-bold mb-6 text-gray-100 flex items-center">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Most Recent Clicks</span>
                </h2>
                <div id="recentClicks" class="grid gap-4 grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                    <!-- Recent clicks will be inserted here -->
                </div>
            </section>

            <!-- Lowest Times Section -->
            <section class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-6 border border-gray-700">
                <h2 class="text-3xl font-bold mb-6 text-gray-100 flex items-center">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Global Leaderboard - Lowest Times</span>
                </h2>
                <div id="lowestTimes" class="grid gap-4 grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                    <!-- Lowest times will be inserted here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden border border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-100">Game Leaderboard</h3>
                        <button onclick="closeLeaderboard()" class="text-gray-400 hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 150px);">
                    <div id="leaderboardContent" class="space-y-4">
                        <!-- Leaderboard content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl max-h-[250vh] overflow-hidden border border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-100">Activity Stats</h3>
                        <button onclick="closeActivity()" class="text-gray-400 hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 150px);">
                    <div id="activityContent" class="space-y-4">
                        <!-- Activity content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSidePanel() {
            document.getElementById('sidePanel').classList.add('active');
            document.getElementById('mainContent').classList.add('shifted');
            document.body.style.overflow = 'hidden';
        }

        function closeSidePanel() {
            document.getElementById('sidePanel').classList.remove('active');
            document.getElementById('mainContent').classList.remove('shifted');
            document.body.style.overflow = 'auto';
        }

        function closeActivity() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        // Utility Functions
        function formatTime(seconds) {
            seconds = Math.max(0, Math.floor(seconds));
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function getColorClass(timeValue, duration) {
            const percentage = (timeValue / duration) * 100;
            if (percentage >= 83.33) return 'color-purple';
            if (percentage >= 66.67) return 'color-blue';
            if (percentage >= 50.00) return 'color-green';
            if (percentage >= 33.33) return 'color-yellow';
            if (percentage >= 16.67) return 'color-orange';
            return 'color-red';
        }

        function getBorderColorClass(timeValue, duration) {
            const percentage = (timeValue / duration) * 100;
            if (percentage >= 83.33) return 'border-color-purple';
            if (percentage >= 66.67) return 'border-color-blue';
            if (percentage >= 50.00) return 'border-color-green';
            if (percentage >= 33.33) return 'border-color-yellow';
            if (percentage >= 16.67) return 'border-color-orange';
            return 'border-color-red';
        }

        // Modal Functions
        async function showLeaderboard(gameId) {
            try {
                const modal = document.getElementById('leaderboardModal');
                const content = document.getElementById('leaderboardContent');
                modal.classList.remove('hidden');
                
                content.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
                
                const response = await fetch(`api.php?action=getGameLeaderboard&gameId=${gameId}`);
                const data = await response.json();
                const leaderboard = Array.isArray(data.data) ? data.data : data;
                
                content.innerHTML = leaderboard.map((entry, index) => `
                    <div class="bg-gray-700 rounded-lg p-4 ${index === 0 ? 'border-2 border-yellow-400' : ''}">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold text-lg text-gray-100">#${index + 1} ${entry.user_name}</span>
                                <div class="text-sm text-gray-300 space-y-1 mt-2">
                                    <div class="flex gap-3">
                                        <span>Total Clicks: ${entry.total_clicks}</span>
                                        <span>•</span>
                                        <span class="${getColorClass(entry.lowest_time, 43200)} px-2 rounded">
                                            Best Time: ${formatTime(entry.lowest_time)}
                                        </span>
                                    </div>
                                    <div>Time Saved: ${formatTime(entry.time_saved)}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400">Last Click</div>
                                <div class="font-mono text-gray-300">
                                    ${new Date(entry.last_click).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (leaderboard.length === 0) {
                    content.innerHTML = '<div class="text-gray-400 p-4 text-center">No leaderboard data available.</div>';
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                content.innerHTML = '<div class="text-red-400 p-4">Failed to load leaderboard data.</div>';
            }
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.add('hidden');
        }

        // Update timers for active games
        function updateTimers() {
            document.querySelectorAll('[data-countdown]').forEach(timer => {
                const lastClickStr = timer.dataset.lastclick;
                const timerDuration = parseInt(timer.dataset.duration);
                
                const lastClick = new Date(lastClickStr + 'Z');
                const now = new Date();
                
                const elapsedSinceClick = Math.floor((now.getTime() - lastClick.getTime()) / 1000);
                const remaining = Math.max(0, timerDuration - elapsedSinceClick);
                
                const timeToShow = Math.min(remaining, timerDuration);
                
                timer.textContent = formatTime(timeToShow);
                const colorClass = getColorClass(timeToShow, timerDuration);
                timer.className = `text-2xl font-mono ${colorClass} text-white p-3 rounded-lg text-center animate-pulse-slow w-full`;
            });
        }

        // Fetch and update game data
        async function fetchGameData() {
            try {
                const response = await fetch('api.php?action=getActiveGames');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch games');
                }
                
                // Filter out games with 0 time remaining
                const games = result.data.filter(game => {
                    const lastClick = new Date(game.last_click + 'Z');
                    const now = new Date();
                    const elapsedSinceClick = Math.floor((now.getTime() - lastClick.getTime()) / 1000);
                    const remaining = Math.max(0, game.timer_duration - elapsedSinceClick);
                    return remaining > 0;
                });

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('activeGames').classList.remove('hidden');
                
                const gamesHtml = games.reverse().map(game => {
                    // Rest of the existing game mapping code remains unchanged
                    const stats = game.stats || {
                        time_to_beat: game.timer_duration,
                        record_holder: 'No record yet',
                        top_claimed_time: 0,
                        top_time_claimer: 'No claims yet',
                        total_players: 0,
                        total_clicks: 0
                    };

                    const colorPattern = game.color_pattern || [];

                    return `
                        <div class="bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-200 border border-gray-700">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <p class="text-xl font-bold text-gray-100">${game.guild_name || `Server ${game.guild_id}`}</p>
                                        <span class="text-xl font-bold text-gray-100"> | Game #${game.id}</span>
                                    </div>
                                    <div class="mt-2 text-sm text-gray-400">
                                        <span>🎯 Time to beat: ${formatTime(stats.time_to_beat)} by ${stats.record_holder}</span>
                                        <span class="mx-2">\n</span>
                                        <span>⚡ Most claimed: ${formatTime(stats.top_claimed_time)} by ${stats.top_time_claimer}</span>
                                    </div>
                                    <div class="mt-1 text-sm text-gray-400">
                                        <span>🎮 ${stats.total_players} players</span>
                                        <span class="mx-2">\n</span>
                                        <span>🔄 ${stats.total_clicks} clicks</span>
                                        <span class="mx-2">\n</span>
                                        <span>⏱️ Alive for ${formatDuration(new Date() - new Date(game.start_time))}</span>
                                    </div>
                                    <div class="mt-2 text-lg">${colorPattern.join('')}</div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <p class="text-gray-400 mb-2">Time Remaining:</p>
                                    <div data-countdown 
                                        data-lastclick="${game.last_click}" 
                                        data-duration="${game.timer_duration}"
                                        class="text-2xl font-mono">
                                        Loading...
                                    </div>
                                </div>
                                
                                <div class="flex justify-between gap-4">
                                    <button onclick="showLeaderboard(${game.id})" 
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg 
                                                transition-colors duration-200 flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        Leaderboard
                                    </button>
                                    <button onclick="showActivity(${game.id})"
                                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg
                                                transition-colors duration-200 flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                        </svg>
                                        Activity
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('activeGames').innerHTML = gamesHtml;

            } catch (error) {
                console.error('Error fetching game data:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }
        }
        
        async function updateGlobalStats() {
            try {
                const response = await fetch('api.php?action=getCombinedStats');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch global stats');
                }
                
                const stats = result.data;
                const statsContainer = document.getElementById('globalStats');
                
                statsContainer.innerHTML = `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-2">Active Games</h4>
                        <p class="text-2xl font-bold text-blue-400">${stats.total_games}</p>
                        <p class="text-gray-300">Total unique players: ${stats.total_unique_players}</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-2">Global Records</h4>
                        <p class="text-gray-300">Best time: ${formatTime(stats.global_best_time)}</p>
                        <p class="text-gray-300">By: ${stats.record_holder}</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-2">Activity Stats</h4>
                        <p class="text-gray-300">Total clicks: ${stats.total_clicks}</p>
                        <p class="text-gray-300">Most active: ${stats.most_active_player}</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-2">Time Stats</h4>
                        <p class="text-gray-300">Total time saved: ${formatTime(stats.total_time_saved)}</p>
                        <p class="text-gray-300">Longest game: ${formatDuration(stats.longest_game_duration * 1000)}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching global stats:', error);
                document.getElementById('globalStats').innerHTML = 
                    '<div class="col-span-2 text-red-400 p-4 text-center">Failed to load global statistics.</div>';
            }
        }

        async function showActivity(gameId) {
            try {
                const modal = document.getElementById('activityModal');
                const content = document.getElementById('activityContent');
                modal.classList.remove('hidden');
                
                content.innerHTML = '<div class="flex justify-center"><div class="loading-spinner"></div></div>';
                
                const response = await fetch(`api.php?action=getActivityStats&gameId=${gameId}`);
                const data = await response.json();
                const stats = data.data;
                
                const hours = Array.from({ length: 24 }, (_, i) => i);
                const maxClicks = Math.max(...stats.map(s => s.click_count));
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-12 gap-1">
                            ${hours.map(hour => {
                                const hourStat = stats.find(s => s.hour === hour) || { click_count: 0 };
                                const intensity = (hourStat.click_count / maxClicks) * 100;
                                return `
                                    <div class="aspect-square relative group cursor-pointer" data-hour="${hour}" data-clicks="${hourStat.click_count}">
                                        <div class="absolute inset-0 bg-blue-500" style="opacity: ${intensity / 100};"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-lg font-bold mb-2">Most Active Hours</h4>
                                ${stats.slice(0, 3).map(stat => `
                                    <div class="flex justify-between items-center">
                                        <span>${stat.hour}:00 - ${stat.hour + 1}:00</span>
                                        <span>${stat.click_count} clicks</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-lg font-bold mb-2">Least Active Hours</h4>
                                ${stats.slice(-3).reverse().map(stat => `
                                    <div class="flex justify-between items-center">
                                        <span>${stat.hour}:00 - ${stat.hour + 1}:00</span>
                                        <span>${stat.click_count} clicks</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.querySelectorAll('#heatmap .group').forEach(cell => {
                    cell.addEventListener('mouseenter', showTooltip);
                    cell.addEventListener('mouseleave', hideTooltip);
                });
                
            } catch (error) {
                console.error('Error loading activity stats:', error);
                content.innerHTML = '<div class="text-red-400 p-4">Failed to load activity data.</div>';
            }
        }

        function showTooltip(e) {
            const cell = e.currentTarget;
            const hour = cell.dataset.hour;
            const clicks = cell.dataset.clicks;

            const tooltip = document.createElement('div');
            tooltip.id = 'activityTooltip';
            tooltip.className = 'fixed bg-gray-900 text-white px-2 py-1 rounded text-sm z-50 pointer-events-none';
            tooltip.innerHTML = `${hour}:00 - ${parseInt(hour) + 1}:00<br>${clicks} clicks`;

            document.body.appendChild(tooltip);

            function positionTooltip(event) {
                tooltip.style.left = event.clientX + 15 + 'px';
                tooltip.style.top = event.clientY + 15 + 'px';
            }

            cell.addEventListener('mousemove', positionTooltip);
            cell._tooltipMouseMoveHandler = positionTooltip;
        }

        function hideTooltip(e) {
            const cell = e.currentTarget;
            const tooltip = document.getElementById('activityTooltip');
            if (tooltip) {
                tooltip.remove();
            }
            if (cell._tooltipMouseMoveHandler) {
                cell.removeEventListener('mousemove', cell._tooltipMouseMoveHandler);
                delete cell._tooltipMouseMoveHandler;
            }
        }

        function getColorEmoji(timeValue, duration) {
            const percentage = (timeValue / duration) * 100;
            if (percentage >= 83.33) return '🟣';
            if (percentage >= 66.67) return '🔵';
            if (percentage >= 50.00) return '🟢';
            if (percentage >= 33.33) return '🟡';
            if (percentage >= 16.67) return '🟠';
            return '🔴';
        }

        function formatDuration(ms) {
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        async function fetchClickLists() {
            try {
                // Fetch both recent clicks and lowest times in parallel
                const [recentResponse, lowestResponse] = await Promise.all([
                    fetch('api.php?action=getRecentClicks&limit=50'),
                    fetch('api.php?action=getLowestClicks&limit=50')
                ]);

                const recentResult = await recentResponse.json();
                const lowestResult = await lowestResponse.json();

                if (!recentResult.success || !lowestResult.success) {
                    throw new Error('Failed to fetch click lists');
                }

                // Update Recent Clicks section
                const recentClicksContainer = document.getElementById('recentClicks');
                recentClicksContainer.innerHTML = recentResult.data.map(click => `
                    <div class="bg-gray-700 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <span class="font-bold text-gray-100">${click.user_name}</span>
                            <span class="text-gray-400 ml-2 text-sm">
                                ${click.guild_name || `Server ${click.guild_id}`}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="${getColorClass(click.timer_value, click.timer_duration)} px-3 py-1 rounded-full">
                                ${formatTime(click.timer_value)}
                            </div>
                            <div class="text-gray-400 text-sm">
                                ${new Date(click.click_time).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');

                // Update Lowest Times section
                const lowestTimesContainer = document.getElementById('lowestTimes');
                lowestTimesContainer.innerHTML = lowestResult.data.map((click, index) => `
                    <div class="bg-gray-700 rounded-lg p-4 flex justify-between items-center ${index === 0 ? 'border-2 ' + getBorderColorClass(click.timer_value, click.timer_duration) : ''}">
                        <div>
                            <span class="font-bold text-gray-100">#${index + 1} ${click.user_name}</span>
                            <span class="text-gray-400 ml-2 text-sm">
                                ${click.guild_name || `Server ${click.guild_id}`}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="${getColorClass(click.timer_value, click.timer_duration)} px-3 py-1 rounded-full">
                                ${formatTime(click.timer_value)}
                            </div>
                            <div class="text-gray-400 text-sm">
                                ${new Date(click.click_time).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error fetching click lists:', error);
                document.getElementById('recentClicks').innerHTML = 
                    '<div class="text-red-400 p-4 text-center">Failed to load recent clicks.</div>';
                document.getElementById('lowestTimes').innerHTML = 
                    '<div class="text-red-400 p-4 text-center">Failed to load lowest times.</div>';
            }
        }

        function openSetupPanel() {
            document.getElementById('setupPanel').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSetupPanel() {
            document.getElementById('setupPanel').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Add to your existing event listener for escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeActivity();
                closeLeaderboard();
                closeSidePanel();
                closeSetupPanel(); // Add this line
            }
        });

        // Add click outside to close
        document.getElementById('setupPanel').addEventListener('click', (e) => {
            if (e.target === document.getElementById('setupPanel')) {
                closeSetupPanel();
            }
        });

        // Initialize and set up refresh intervals
        async function initialize() {
            await Promise.all([
                fetchGameData(),
                fetchClickLists(),
                updateGlobalStats()
            ]);
            
            // Update timers every second
            setInterval(updateTimers, 1000);
            
            // Refresh game data every 30 seconds
            setInterval(fetchGameData, 30000);
            
            // Refresh click lists every minute
            setInterval(fetchClickLists, 60000);
            
            // Refresh global stats every 5 minutes
            setInterval(updateGlobalStats, 300000);
        }

        // Close modal when clicking outside
        document.getElementById('leaderboardModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('leaderboardModal')) {
                closeLeaderboard();
            }
        });

        // Handle escape key for modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeActivity();
                closeLeaderboard();
                closeSidePanel();
            }
        });
        
        document.getElementById('activityModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('activityModal')) {
                closeActivity();
            }
        });

        // Start the application
        initialize();
    </script>
</body>
</html>
